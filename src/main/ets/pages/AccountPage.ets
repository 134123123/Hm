// src/main/ets/pages/AccountPage.ets
import router from '@ohos.router';
import http from '@ohos.net.http';
// 1. âœ… ä¿®å¤è·¯å¾„ï¼šä½¿ç”¨ ../ æ‰¾åˆ° model æ–‡ä»¶å¤¹
import { AccountModel } from '../model/AccountModel';

// ==========================================
// å®šä¹‰ä¸¥æ ¼çš„æ•°æ®ç»“æ„ (æ¶ˆé™¤ Property 'xxx' has no initializer æŠ¥é”™)
// ==========================================

// åç«¯è¿”å›çš„ç»Ÿä¸€ç»“æ„
class ResponseResult<T> {
  code: number
  msg: string
  data: T

  // âœ… å¿…é¡»æœ‰æ„é€ å‡½æ•°è¿›è¡Œåˆå§‹åŒ–
  constructor(code: number, msg: string, data: T) {
    this.code = code
    this.msg = msg
    this.data = data
  }
}

class StatsData {
  totalOut: number = 0
  totalIn: number = 0
}

// ç•Œé¢æ˜¾ç¤ºçš„â€œæ¯ä¸€è¡Œâ€
class AccountItem {
  id: number
  title: string
  time: string
  amount: string
  type: string
  icon: Resource

  constructor(id: number, title: string, time: string, amount: string, type: string, icon: Resource) {
    this.id = id
    this.title = title
    this.time = time
    this.amount = amount
    this.type = type
    this.icon = icon
  }
}

// ç•Œé¢æ˜¾ç¤ºçš„â€œæ¯ä¸€å¤©â€ (åˆ†ç»„)
class DayRecord {
  date: string
  items: AccountItem[]

  constructor(date: string, items: AccountItem[]) {
    this.date = date
    this.items = items
  }
}

@Entry
@Component
struct AccountPage {

  private baseUrl: string = 'http://192.168.63.229:8080';
  private currentUserId: number = 1;

  @State currentMonth: string = '2023å¹´12æœˆ'
  @State totalOut: string = '0.00'
  @State totalIn: string = '0.00'

  // æœ€ç»ˆç»™ UI æ¸²æŸ“çš„æ•°æ®æ•°ç»„
  @State records: DayRecord[] = []

  onPageShow() {
    this.loadStats(); // åŠ è½½å¤´éƒ¨ç»Ÿè®¡
    this.loadList();  // åŠ è½½åˆ—è¡¨
  }

  // ğŸ”¥ 1. åŠ è½½å¤´éƒ¨ç»Ÿè®¡ (æ€»æ”¶å…¥/æ€»æ”¯å‡º)
  loadStats() {
    let httpRequest = http.createHttp();
    let url = `${this.baseUrl}/account/stats?userId=${this.currentUserId}`;

    httpRequest.request(url, { method: http.RequestMethod.GET }, (err, data) => {
      if (!err && data.responseCode === 200) {
        // âœ… ä¿®å¤ï¼šä½¿ç”¨ ResponseResult<StatsData> æ›¿ä»£ any
        let res = JSON.parse(data.result.toString()) as ResponseResult<StatsData>;
        if (res.code === 1) {
          // åç«¯è¿”å›çš„æ˜¯æ•°å­—ï¼Œæˆ‘ä»¬è½¬æˆå­—ç¬¦ä¸²ä¿ç•™2ä½å°æ•°
          // æ³¨æ„ï¼šåç«¯å¯èƒ½è¿”å› nullï¼Œè¿™é‡Œåšä¸€ä¸ªå®‰å…¨å¤„ç†
          let outVal = res.data.totalOut ? res.data.totalOut : 0;
          let inVal = res.data.totalIn ? res.data.totalIn : 0;

          this.totalOut = Number(outVal).toFixed(2);
          this.totalIn = Number(inVal).toFixed(2);
        }
      }
    });
  }

  // ğŸ”¥ 2. åŠ è½½æµæ°´åˆ—è¡¨
  loadList() {
    let httpRequest = http.createHttp();
    let url = `${this.baseUrl}/account/list?userId=${this.currentUserId}`;

    httpRequest.request(url, { method: http.RequestMethod.GET }, (err, data) => {
      if (!err && data.responseCode === 200) {
        // âœ… ä¿®å¤ï¼šæ˜ç¡®æŒ‡å®šæ³›å‹ä¸º AccountModel[]
        let res = JSON.parse(data.result.toString()) as ResponseResult<AccountModel[]>;
        if (res.code === 1) {
          // æ‹¿åˆ°åŸå§‹æ•°æ®ï¼Œè¿›è¡Œåˆ†ç»„å¤„ç†
          this.processData(res.data);
        }
      }
    });
  }

  // ğŸ”¥ 3. æ ¸å¿ƒç®—æ³•ï¼šæŠŠæ‰å¹³çš„åˆ—è¡¨æŒ‰æ—¥æœŸåˆ†ç»„
  processData(list: AccountModel[]) {
    let groupMap = new Map<string, AccountItem[]>();
    let dateOrder: string[] = []; // è®°å½•æ—¥æœŸå‡ºç°çš„é¡ºåº

    // âœ… ä¿®å¤ï¼šç»™ item åŠ ä¸Šæ˜ç¡®ç±»å‹ AccountModel
    list.forEach((item: AccountModel) => {
      // 1. æå–æ—¥æœŸ (YYYY-MM-DD) å’Œ æ—¶é—´ (HH:mm)
      // item.createTime æ ¼å¼å‡è®¾ä¸º "2023-12-21 12:00:00"
      let dateStr = item.createTime.split(' ')[0]; // æ‹¿ "2023-12-21"
      let timeStr = "";
      if (item.createTime.split(' ').length > 1) {
        timeStr = item.createTime.split(' ')[1].substring(0, 5); // æ‹¿ "12:00"
      }

      // 2. è½¬æ¢å¯¹è±¡
      let uiItem = new AccountItem(
        item.id,
        item.title,
        `${timeStr} | ${item.remark || 'æ— å¤‡æ³¨'}`,
        (item.type === 'out' ? '-' : '+') + Number(item.amount).toFixed(2),
        item.type,
        // æ ¹æ®ç±»å‹åˆ†é…é»˜è®¤å›¾æ ‡
        item.type === 'out' ? $r('app.media.ic_public_folder_filled') : $r('app.media.ic_public_input_user')
      );

      // 3. æ”¾å…¥ Map
      if (!groupMap.has(dateStr)) {
        groupMap.set(dateStr, []);
        dateOrder.push(dateStr); // è®°å½•æ–°å‡ºç°çš„æ—¥æœŸ
      }
      let group = groupMap.get(dateStr);
      if (group) {
        group.push(uiItem);
      }
    });

    // 4. ç»„è£…æˆ UI éœ€è¦çš„ç»“æ„
    let finalRecords: DayRecord[] = [];
    // âœ… ä¿®å¤ï¼šç»™ date åŠ ä¸Šæ˜ç¡®ç±»å‹ string
    dateOrder.forEach((date: string) => {
      let items = groupMap.get(date);
      if (items) {
        finalRecords.push(new DayRecord(date, items));
      }
    });

    this.records = finalRecords;
  }

  build() {
    Column() {
      // 1. é¡¶éƒ¨è“è‰²åŒºåŸŸ
      Column() {
        // å¯¼èˆªæ 
        Row() {
          Image($r('app.media.ic_public_arrow_left'))
            .width(24).height(24).fillColor(Color.White)
            .onClick(() => router.back())
          Text('è´¦æœ¬').fontSize(20).fontColor(Color.White).fontWeight(FontWeight.Bold).margin({ left: 16 })
          Blank()
          Image($r('app.media.ic_public_more')).width(24).height(24).fillColor(Color.White)
        }
        .width('100%').height(56).padding({ left: 16, right: 16 })

        // "æ˜ç»† / ç»Ÿè®¡" åˆ‡æ¢
        Row() {
          Text('æ˜ç»†').fontSize(18).fontColor(Color.White).fontWeight(FontWeight.Bold).margin({ right: 20 })
          Text('ç»Ÿè®¡').fontSize(16).fontColor('#D0D0D0')
        }
        .width('100%').padding({ left: 20, bottom: 10 })

        // æœˆä»½å’Œæ€»è§ˆ
        Row() {
          Row() {
            Text(this.currentMonth).fontSize(16).fontColor(Color.White)
            Image($r('app.media.ic_public_arrow_right')).width(12).height(12).fillColor(Color.White).rotate({ angle: 90 }).margin({ left: 4 })
          }
          .padding({ top: 4, bottom: 4, left: 8, right: 8 })
          .backgroundColor('#40FFFFFF').borderRadius(12)

          Blank()
          Text(`æ€»æ”¯å‡º: Â¥${this.totalOut}`).fontSize(12).fontColor(Color.White).margin({ right: 10 })
          Text(`æ€»å…¥è´¦: Â¥${this.totalIn}`).fontSize(12).fontColor(Color.White)
        }
        .width('100%').padding({ left: 16, right: 16, bottom: 20 })

      }
      .width('100%')
      .backgroundColor('#5B8FF9')

      // 2. è´¦å•åˆ—è¡¨
      List() {
        ForEach(this.records, (dayRecord: DayRecord) => {
          // æ—¥æœŸå¤´
          ListItem() {
            Row() {
              Text(dayRecord.date).fontSize(14).fontColor('#999')
              Blank()
            }
            .width('100%').padding({ left: 16, right: 16, top: 12, bottom: 4 })
            .backgroundColor('#F5F5F5')
          }

          // å½“å¤©çš„æ¯ä¸€ç¬”è®°å½•
          ForEach(dayRecord.items, (item: AccountItem) => {
            ListItem() {
              Row() {
                // å›¾æ ‡èƒŒæ™¯
                Column() {
                  Image(item.icon).width(24).height(24).fillColor(Color.White)
                }
                .width(40).height(40).borderRadius(20).backgroundColor('#8EA0E6')
                .justifyContent(FlexAlign.Center).alignItems(HorizontalAlign.Center)
                .margin({ right: 12 })

                // ä¿¡æ¯
                Column() {
                  Text(item.title).fontSize(16).fontColor('#333')
                  Text(item.time).fontSize(12).fontColor('#999').margin({ top: 4 })
                }
                .alignItems(HorizontalAlign.Start)
                .layoutWeight(1)

                // é‡‘é¢
                Text(item.amount)
                  .fontSize(18)
                  .fontWeight(FontWeight.Bold)
                  .fontColor(item.type === 'out' ? '#333' : '#E65B5B') // æ”¯å‡ºé»‘è‰²ï¼Œæ”¶å…¥çº¢è‰²
              }
              .width('100%').padding(16).backgroundColor(Color.White)
              .border({ width: { bottom: 1 }, color: '#F0F0F0' })
            }
          })
        })
      }
      .width('100%')
      .layoutWeight(1)
      .backgroundColor('#F5F5F5')
    }
    .width('100%').height('100%')
  }
}