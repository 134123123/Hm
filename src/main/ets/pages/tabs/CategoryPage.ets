import http from '@ohos.net.http';
import promptAction from '@ohos.promptAction';
import router from '@ohos.router';

// 1. å®šä¹‰æ•°æ®æ¨¡å‹
class CategoryModel {
  id: number
  name: string
  userId: number
  constructor(id: number, name: string, userId: number) {
    this.id = id; this.name = name; this.userId = userId;
  }
}

// 2. æ³›å‹å“åº”ç±» (è§£å†³ any æŠ¥é”™çš„å…³é”®)
class ResponseResult<T> {
  code: number
  msg: string
  data: T
  constructor(code: number, msg: string, data: T) {
    this.code = code; this.msg = msg; this.data = data;
  }
}

// 3. è¯·æ±‚å‚æ•°ç±»
class CategoryReq {
  id?: number
  name: string
  userId: number
  constructor(name: string, userId: number, id?: number) {
    this.name = name; this.userId = userId; this.id = id;
  }
}

// 4. æ–°å»º/ç¼–è¾‘å¼¹çª—
@CustomDialog
struct CategoryDialog {
  controller: CustomDialogController
  title: string = 'æ–°å»ºåˆ†ç±»'
  inputValue: string = ''
  confirmAction: (name: string) => void = () => {}
  @State inputName: string = ''

  aboutToAppear() {
    this.inputName = this.inputValue
  }

  build() {
    Column() {
      Text(this.title).fontSize(18).fontWeight(FontWeight.Bold).margin({ top: 24, bottom: 16 })

      TextInput({ placeholder: 'è¯·è¾“å…¥åˆ†ç±»åç§°', text: this.inputName })
        .backgroundColor('#F5F5F5').height(50).borderRadius(8).width('90%')
        .onChange((val) => this.inputName = val)

      Row() {
        Button('å–æ¶ˆ').backgroundColor(Color.White).fontColor('#666')
          .onClick(() => this.controller.close())

        Button('ç¡®å®š').backgroundColor('#FFD700').fontColor('#333')
          .onClick(() => {
            if (this.inputName) {
              this.confirmAction(this.inputName)
              this.controller.close()
            } else {
              promptAction.showToast({ message: 'åç§°ä¸èƒ½ä¸ºç©º' })
            }
          })
      }
      .margin({ top: 20, bottom: 20 }).width('100%').justifyContent(FlexAlign.SpaceEvenly)
    }
    .backgroundColor(Color.White).borderRadius(16).width('80%')
  }
}

@Component
export struct CategoryPage {
  @State categoryList: CategoryModel[] = []
  private baseUrl: string = 'http://192.168.63.229:8080';
  @StorageProp('loginUserId') currentUserId: number = 0;

  // èœå•çŠ¶æ€
  @State isMenuShow: boolean = false
  @State selectedCategory: CategoryModel | null = null

  // å¼¹çª—æ§åˆ¶å™¨ (æ‡’åŠ è½½ï¼Œåˆå§‹ä¸º null)
  dialogController: CustomDialogController | null = null;

  aboutToAppear() {
    this.loadData();
  }

  // åŠ è½½æ•°æ®
  loadData() {
    if (this.currentUserId === 0) return;
    let httpRequest = http.createHttp();
    httpRequest.request(`${this.baseUrl}/category/list?userId=${this.currentUserId}`, {
      method: http.RequestMethod.GET
    }, (err, data) => {
      if (!err && data.responseCode === 200) {
        // âœ… æ ¸å¿ƒä¿®å¤ï¼šä½¿ç”¨æ³›å‹æ–­è¨€ï¼Œæ¶ˆé™¤ any
        let res = JSON.parse(data.result.toString()) as ResponseResult<CategoryModel[]>;
        if (res.code === 1) {
          this.categoryList = res.data || [];
        }
      }
    });
  }

  // æ‰“å¼€å¼¹çª— (mode: false=æ–°å»º, true=ç¼–è¾‘)
  openDialog(isEdit: boolean) {
    let title = isEdit ? 'ç¼–è¾‘åˆ†ç±»' : 'æ–°å»ºåˆ†ç±»';
    let initialValue = (isEdit && this.selectedCategory) ? this.selectedCategory.name : '';

    this.dialogController = new CustomDialogController({
      builder: CategoryDialog({
        title: title,
        inputValue: initialValue,
        confirmAction: (name: string) => {
          if (isEdit && this.selectedCategory) {
            this.updateCategory(this.selectedCategory.id, name);
          } else {
            this.addCategory(name);
          }
        }
      }),
      autoCancel: true,
      alignment: DialogAlignment.Center
    })
    this.dialogController.open();
  }

  // æ·»åŠ åˆ†ç±»
  addCategory(name: string) {
    let req = new CategoryReq(name, this.currentUserId);
    this.sendRequest(`${this.baseUrl}/category/add`, req, 'æ·»åŠ æˆåŠŸ');
  }

  // ä¿®æ”¹åˆ†ç±»
  updateCategory(id: number, name: string) {
    let req = new CategoryReq(name, this.currentUserId, id);
    this.sendRequest(`${this.baseUrl}/category/update`, req, 'ä¿®æ”¹æˆåŠŸ');
  }

  // åˆ é™¤åˆ†ç±»
  deleteCategory(id: number) {
    let httpRequest = http.createHttp();
    httpRequest.request(`${this.baseUrl}/category/delete?id=${id}`, {
      method: http.RequestMethod.GET
    }, (err, data) => {
      if (!err && data.responseCode === 200) {
        promptAction.showToast({ message: 'åˆ é™¤æˆåŠŸ' });
        this.loadData();
      }
    });
  }

  // é€šç”¨è¯·æ±‚å‘é€
  sendRequest(url: string, data: CategoryReq, successMsg: string) {
    let httpRequest = http.createHttp();
    httpRequest.request(url, {
      method: http.RequestMethod.POST,
      header: { 'Content-Type': 'application/json' },
      extraData: data
    }, (err, res) => {
      if (!err && res.responseCode === 200) {
        promptAction.showToast({ message: successMsg });
        this.loadData();
      }
    });
  }

  // åº•éƒ¨èœå• Builder
  @Builder MenuSheet() {
    Column() {
      Text('ç¼–è¾‘').width('100%').textAlign(TextAlign.Center).padding(16).fontSize(16).fontColor('#333')
        .border({ width: { bottom: 1 }, color: '#F0F0F0' })
        .onClick(() => {
          this.isMenuShow = false;
          this.openDialog(true); // æ‰“å¼€ç¼–è¾‘æ¡†
        })

      Text('åˆ é™¤').width('100%').textAlign(TextAlign.Center).padding(16).fontSize(16).fontColor('#FF4D4F')
        .border({ width: { bottom: 1 }, color: '#F0F0F0' })
        .onClick(() => {
          this.isMenuShow = false;
          if (this.selectedCategory) {
            // å¯ä»¥åœ¨è¿™é‡ŒåŠ ä¸ªäºŒæ¬¡ç¡®è®¤å¼¹çª—
            this.deleteCategory(this.selectedCategory.id);
          }
        })

      Divider().color('#F5F5F5').strokeWidth(8)
      Text('å–æ¶ˆ').width('100%').textAlign(TextAlign.Center).padding(16).fontSize(16)
        .onClick(() => this.isMenuShow = false)
    }
    .width('100%').backgroundColor(Color.White).borderRadius({ topLeft: 16, topRight: 16 })
  }

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text('åˆ†ç±»').fontSize(26).fontColor('#333').fontWeight(FontWeight.Bold)
        Blank()
        Image($r('app.media.ic_public_add')).width(28).height(28).fillColor('#333')
          .onClick(() => {
            this.selectedCategory = null;
            this.openDialog(false); // æ–°å»ºæ¨¡å¼
          })
      }
      .width('100%').height(64).backgroundColor(Color.White).padding({ left: 24, right: 24 })
      .shadow({ radius: 2, color: 'rgba(0,0,0,0.03)', offsetY: 2 })

      // åˆ—è¡¨å†…å®¹
      if (this.categoryList.length === 0) {
        Column() {
          Image($r('app.media.ic_public_folder')).width(60).height(60).fillColor('#DDD')
          Text('æš‚æ— åˆ†ç±»').fontSize(14).fontColor('#999').margin({ top: 10 })
        }.width('100%').height('60%').justifyContent(FlexAlign.Center)
      } else {
        List({ space: 12 }) {
          ForEach(this.categoryList, (item: CategoryModel) => {
            ListItem() {
              Row() {
                Image($r('app.media.ic_public_folder_filled')).width(24).height(24).fillColor('#FFD700').margin({ right: 16 })
                Text(item.name).fontSize(17).fontColor('#333').fontWeight(FontWeight.Medium)
                Blank()
                Image($r('app.media.ic_public_arrow_right')).width(16).height(16).fillColor('#CCC')
              }
              .width('100%').padding(18).backgroundColor(Color.White).borderRadius(16)
              .shadow({ radius: 4, color: 'rgba(0,0,0,0.03)', offsetY: 2 })
            }
            .onClick(() => {
              // ğŸ”¥ ç‚¹å‡»è·³è½¬åˆ°åˆ†ç±»è¯¦æƒ…é¡µ
              router.pushUrl({
                url: 'pages/CategoryNoteListPage',
                params: { categoryId: item.id, categoryName: item.name }
              })
            })
            // ğŸ”¥ é•¿æŒ‰å¼¹å‡ºèœå•
            .gesture(
              LongPressGesture().onAction(() => {
                this.selectedCategory = item;
                this.isMenuShow = true;
              })
            )
          })
        }
        .width('92%').layoutWeight(1).margin({ top: 16 })
      }
    }
    .width('100%').height('100%').backgroundColor('#F8F9FA')
    .bindSheet($$this.isMenuShow, this.MenuSheet(), { height: SheetSize.FIT_CONTENT, dragBar: false })
  }
}